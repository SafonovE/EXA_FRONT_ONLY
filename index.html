<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Интерактивный Дашборд Инцидентов</title>

  <!-- Внешние библиотеки (всё локально в браузере) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- PptxGenJS -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* --- Стиль кнопок периода (оставлено как было) --- */
    .segabtn {
      font-family: 'Montserrat','Arial',sans-serif; font-size: 1em;
      padding: 10px 22px; border: 2.5px solid #0ff; background: #172550; color: #fff;
      border-radius: 12px; margin: 0 8px 10px 0;
      box-shadow: 0 2px 0 #00d0ff, 0 0 6px #00eaff70;
      cursor: pointer; transition: background .13s, box-shadow .1s, transform .13s;
      outline: none; min-width: 105px; min-height: 38px; display: inline-block;
    }
    .segabtn.active, .segabtn:focus {
      background: #ffe169; border-color: #ffd500; color: #1c1a1f;
      box-shadow: 0 0 0 3px #ffe16977, 0 8px 22px #ffe16955;
      transform: scale(1.05); z-index: 2;
    }
    .segabtn:hover:not(.active){
      background: #1bd8fd; color:#192f6e; border-color:#0ff;
      box-shadow: 0 0 12px #0ff, 0 2px 8px #1ae6ff; transform: translateY(-2px) scale(1.03);
    }
    .pg-btn{ padding: 6px 14px; border-radius: 6px; margin:0 2px; border:1px solid #e0e0f0; background:#f8fafc; cursor:pointer;}
    .pg-btn.active{ background:#6366f1; color:#fff; border-color:#6366f1; font-weight:bold;}
    .pg-btn:disabled{ background:#ececec; color:#b5b5b5; cursor:default;}

    .info-tip{ display:inline-block; background:#f1f5f9; color:#6366f1; border-radius:50%; border:1.5px solid #6366f1;
      font-size:1.04em; font-weight:bold; width:1.33em; height:1.33em; text-align:center; cursor:pointer;
      margin-left:8px; line-height:1.22em; transition:background .2s; position:relative;}
    .info-tip:hover{ background:#6366f1; color:#fff;}
    .info-tip[data-tooltip]:hover:after{
      content: attr(data-tooltip); position:absolute; left:115%; top:45%; transform: translateY(-50%);
      background:#fff; color:#222; padding:7px 12px; border-radius:7px; min-width:160px; max-width:350px;
      box-shadow:0 2px 16px #acb6d633; font-size:13px; z-index:10; white-space: pre-line;
    }

    .reasons-list{ margin:10px 0 12px 0; padding-left:0;}
    .reasons-list li{
      background:#f7f7fa; border-left:4px solid #818cf8; border-radius:8px; margin-bottom:8px; padding:10px 16px;
      font-size:1.08em; font-weight:500; color:#4338ca; line-height:1.5; word-break: break-word; list-style:none;
    }

    /* --- Модалка редактора презентации --- */
    #slide-editor-modal{ display:none; position:fixed; inset:0; z-index:9999; background: rgba(0,0,0,.55); backdrop-filter: blur(3px);}
    #slide-editor-content{ background:#fff; width:99vw; max-width:1200px; min-height:80vh; margin:2vh auto; border-radius:16px;
      padding:1.8vw 1.5vw 2vw 1.5vw; box-shadow:0 4px 32px rgba(0,0,0,.18); overflow-y:auto; max-height:95vh;}
    .editor-toolbar{ flex-wrap:wrap;}
    .editor-toolbar button{ margin-right:8px; margin-bottom:6px; padding:6px 14px; background:#6366f1; color:#fff; border:none; border-radius:8px; cursor:pointer;}
    .editor-toolbar button:hover{ background:#4f46e5;}
    .slide-block{ background:#f8f9fc; border:1.5px dashed #d1d5db; padding:2vw; border-radius:14px; margin-bottom:20px; box-shadow:0 2px 12px #9193b41c;
      transition: box-shadow .15s; width:100%; max-width:950px; margin-left:auto; margin-right:auto; position:relative; overflow-x:auto;}
    .slide-block-toolbar{ position:absolute; top:12px; right:16px;}
    .slide-block-toolbar button{ margin-left:4px; vertical-align:middle; font-size:15px;}
    .slide-block-label{ font-weight:bold; font-size:1.12em; color:#6366f1; margin-bottom:8px;}
    .slide-empty-msg{ color:#b7b5d1; text-align:center; padding:18px 8px 12px;}
    .slide-block-corptext{ background:#f1f5f9; border-radius:7px; margin:16px 0 0 0; padding:13px 17px; min-height:30px; border:1.1px solid #dbeafe; font-size:1.04em;}
    .slide-block-corptext[contenteditable="true"]:focus{ outline:2px solid #818cf8; background:#eef2ff;}
    .slide-block-uploadimg{ max-width:93%; margin:0 auto .8em auto; display:block; border-radius:11px; box-shadow:0 2px 8px #b4b5f33d;}

    /* --- Оверлей загрузки --- */
    #loading-overlay{ display:none; position:fixed; inset:0; z-index:9999; background:rgba(32,22,67,.21); backdrop-filter: blur(2px);}
  </style>
</head>
<body class="bg-gray-50">

<!-- Оверлей "идёт загрузка" -->
<div id="loading-overlay">
  <div style="position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-family:'Montserrat',monospace;font-size:1.3em;color:#522eff;text-align:center;">
    <div class="animate-bounce" style="font-size:2em;">⏳</div>
    <div style="margin-top:12px;">ИДЕТ ЗАГРУЗКА<br><span class="animate-pulse">•••••••••</span></div>
  </div>
</div>

<div class="container mx-auto py-6 px-2 md:px-6 max-w-6xl">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-1">Интерактивный Дашборд Инцидентов</h1>
    <p class="text-gray-600">Аналитика IT инцидентов сервисов БКС «Мир инвестиций»</p>
  </div>

  <!-- Блок загрузки файла -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-2">
      Загрузите файл с данными
      <span class="info-tip" data-tooltip="Программа автоматически определяет структуру файла и формирует дашборд для анализа.">i</span>
    </h2>

    <form id="upload-form" class="mb-3">
      <label for="file-upload" class="flex flex-col items-center justify-center border-2 border-dashed border-indigo-400 rounded-md p-6 cursor-pointer bg-indigo-50 hover:bg-indigo-100 transition">
        <svg class="w-12 h-12 text-indigo-400 mb-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M16 16v2a2 2 0 002 2H6a2 2 0 01-2-2v-2m12-6l-4-4m0 0L8 10m4-4v12"></path>
        </svg>
        <input id="file-upload" name="file" type="file" class="hidden" required />
        <span class="text-indigo-600 font-semibold">Перетащите файл сюда или <span class="underline">Выберите файл</span></span>
        <span class="text-gray-400 text-sm mt-1">CSV или Excel</span>
      </label>
      <button type="submit" class="mt-3 px-6 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">Анализировать данные</button>
    </form>

    <div id="file-info" class="p-3 mt-2 hidden bg-green-100 text-green-700 rounded flex items-center space-x-2 font-semibold"></div>
  </div>

  <!-- Сюда будет собираться весь дашборд -->
  <div id="dashboard-content"></div>
</div>

<script>
/* =========================================================
   ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И НАСТРОЙКИ
   ========================================================= */
const COL_HINTS = {
  date:        ["дата","date","incident","время","timestamp"],
  service:     ["сервис","service","система","бизнес сервис","application"],
  reason:      ["причина","reason","root","проблема","обоснование","cause"],
  responsible: ["ответственный","responsible","виновник","owner","executor","исполнитель"]
};
let RAW_DATA = [], RAW_HEADERS = [], RAW_FILENAME = "", RAW_ROWS = [];
let DASHBOARD_STATE = {}; let PAGE_SIZE = 20; let EXCEL_1904 = false;
const RU_WEEKDAYS = ["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"];
function showLoading(show=true){ document.getElementById('loading-overlay').style.display = show ? '' : 'none'; }

/* =========================================================
   ПАРСИНГ ДАТ (Safari/Chrome/Excel одинаково)
   ========================================================= */
function excelSerialToUTCDate(serial){
  const base = EXCEL_1904 ? Date.UTC(1904,0,1) : Date.UTC(1899,11,30);
  return new Date(base + serial * 86400000);
}
function parseDateAnyStrict(value){
  if(value == null || value === "") return null;
  if(Object.prototype.toString.call(value) === "[object Date]"){
    if(isNaN(value)) return null;
    return new Date(Date.UTC(value.getUTCFullYear(), value.getUTCMonth(), value.getUTCDate()));
  }
  if(typeof value === "number" || /^\d+$/.test(String(value))){
    const d = excelSerialToUTCDate(Number(value));
    return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  }
  const s = String(value).trim();
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s].*)?$/);
  if(iso) return new Date(Date.UTC(+iso[1], +iso[2]-1, +iso[3]));
  const dmY = s.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
  if(dmY){ let day=+dmY[1], month=+dmY[2], year=+dmY[3]; if(year<100) year+=2000; return new Date(Date.UTC(year, month-1, day)); }
  const mdY = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(mdY) return new Date(Date.UTC(+mdY[3], +mdY[1]-1, +mdY[2]));
  const d = new Date(s);
  if(!isNaN(d)) return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  return null;
}
function formatDateRuUTC(date){
  if(!(date instanceof Date) || isNaN(date)) return "";
  const dd = String(date.getUTCDate()).padStart(2,"0");
  const mm = String(date.getUTCMonth()+1).padStart(2,"0");
  const yy = date.getUTCFullYear();
  return `${dd}.${mm}.${yy}`;
}
function isoWeekStringUTC(date){
  const tmp = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
  const day = tmp.getUTCDay() || 7; tmp.setUTCDate(tmp.getUTCDate() + (4 - day));
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
  return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
}

/* =========================================================
   ЗАГРУЗКА ФАЙЛА И ПОДГОТОВКА ДАННЫХ
   ========================================================= */
document.getElementById('upload-form').onsubmit = function(e){
  e.preventDefault();
  const file = document.getElementById('file-upload').files[0];
  if(!file) return alert('Сначала выберите файл!');
  showLoading(true);

  const reader = new FileReader();
  reader.onload = function(evt){
    try{
      const workbook = XLSX.read(evt.target.result, { type:'binary', cellDates:true });
      EXCEL_1904 = !!(workbook && workbook.Workbook && workbook.Workbook.WBProps && workbook.Workbook.WBProps.date1904);
      const ws = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:"", raw:false });

      RAW_FILENAME = file.name; RAW_ROWS = rows;
      autoDetectAndProcess(rows, file.name);
    }catch(err){
      console.error(err); showLoading(false); alert('Ошибка чтения файла: ' + err.message);
    }
  };
  reader.onerror = function(){ showLoading(false); alert('Ошибка чтения файла!'); };
  reader.readAsBinaryString(file);
};
function setFileInfo(filename, rowsCount){
  const el = document.getElementById('file-info');
  el.textContent = `✔️ Файл: ${filename}, строк: ${rowsCount}`;
  el.classList.remove('hidden');
}
function autoDetectAndProcess(rows, filename){
  showLoading(false);
  const headers = rows[0].map(h => String(h||"").trim().toLowerCase());
  function findColIndex(hints){
    for(let i=0;i<headers.length;i++) for(const word of hints){ if(headers[i] && headers[i].trim() === word) return i; }
    return -1;
  }
  const colIdx = {
    date:        findColIndex(COL_HINTS.date),
    service:     findColIndex(COL_HINTS.service),
    reason:      findColIndex(COL_HINTS.reason),
    responsible: findColIndex(COL_HINTS.responsible),
  };

  if(Object.values(colIdx).every(i => i !== -1)){
    const data = rows.slice(1)
      .filter(r => r.length>1 && r.some(c => c && String(c).trim() !== ""))
      .map(r => ({ date:r[colIdx.date], service:r[colIdx.service], reason:r[colIdx.reason], responsible:r[colIdx.responsible] }));
    RAW_DATA = data; RAW_HEADERS = headers; buildDashboard(data, filename);
  } else {
    askUserToSelectColumns(headers, rows, filename);
  }
}
function askUserToSelectColumns(headers, rows, filename){
  document.getElementById('dashboard-content').innerHTML = `
    <div class="bg-white rounded-lg shadow-md p-8 max-w-xl mx-auto">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">Выбор колонок для анализа</h2>
      <p class="mb-4 text-gray-600">Не удалось определить все столбцы автоматически.<br>Пожалуйста, выберите вручную:</p>
      <form id="col-select-form" class="space-y-4">
        ${['date','service','reason','responsible'].map(field => `
          <div>
            <label class="block text-gray-700 mb-1 font-semibold">
              ${ {date:"Дата инцидента", service:"Сервис", reason:"Причина", responsible:"Ответственный"}[field] }:
            </label>
            <select name="${field}" required class="w-full border border-gray-300 rounded-md px-3 py-2">
              ${headers.map((h,i)=>`<option value="${i}">${rows[0][i]}</option>`).join('')}
            </select>
          </div>`).join('')}
        <button type="submit" class="mt-4 w-full px-4 py-2 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-700">Применить выбранные колонки</button>
      </form>

      <div class="mt-6">
        <h3 class="text-lg font-semibold mb-1">Превью данных (первые строки):</h3>
        <div class="overflow-x-auto text-xs bg-gray-50 rounded-lg p-2" style="max-height:300px;">
          <table class="min-w-full">
            <thead><tr>${rows[0].map(h=>`<th class="px-2 py-1">${h}</th>`).join('')}</tr></thead>
            <tbody>
              ${rows.slice(1,8).map(r=>`<tr>${r.map(c=>`<td class="px-2 py-1">${c}</td>`).join('')}</tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  document.getElementById('col-select-form').onsubmit = function(ev){
    ev.preventDefault();
    const f = ev.target;
    const idx = { date:+f.date.value, service:+f.service.value, reason:+f.reason.value, responsible:+f.responsible.value };
    const data = rows.slice(1)
      .filter(r => r.length>1 && r.some(c => c && String(c).trim()!==""))
      .map(r => ({ date:r[idx.date], service:r[idx.service], reason:r[idx.reason], responsible:r[idx.responsible] }));
    RAW_DATA = data; RAW_HEADERS = headers; buildDashboard(data, filename);
  };
}

/* =========================================================
   АНАЛИТИКА
   ========================================================= */
function groupByPeriod(data, period){
  const fmt = {
    day:     d => d.toISOString().slice(0,10),
    week:    d => isoWeekStringUTC(d),
    month:   d => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}`,
    quarter: d => `${d.getUTCFullYear()}-Q${Math.floor(d.getUTCMonth()/3)+1}`,
    year:    d => String(d.getUTCFullYear())
  }[period] || (d => d.toISOString().slice(0,10));
  const map = {};
  data.forEach(r => { const key = fmt(r._date); map[key] = (map[key]||0)+1; });
  const keys = Object.keys(map).sort();
  return { labels: keys, counts: keys.map(k => map[k]) };
}
function findMaxKey(obj){ let max=0,key=""; for(const k in obj){ if(obj[k]>max){max=obj[k]; key=k;} } return key||"-"; }
function getNextPeriods(lastLabel, periodType, count){
  if(!lastLabel) return Array.from({length:count}, (_,i)=>`+${i+1}`);
  const res = [];
  if(periodType === 'day' && /^\d{4}-\d{2}-\d{2}$/.test(lastLabel)){
    const [y,m,d] = lastLabel.split('-').map(Number);
    const base = new Date(Date.UTC(y,m-1,d));
    for(let i=1;i<=count;i++){ const t=new Date(base); t.setUTCDate(t.getUTCDate()+i); res.push(formatDateRuUTC(t)); }
    return res;
  }
  if(periodType === 'month' && /^(\d{4})-(\d{2})$/.test(lastLabel)){
    const m = lastLabel.match(/^(\d{4})-(\d{2})$/); let year=+m[1], month=+m[2];
    for(let i=1;i<=count;i++){ const newMonth=month+i; const newYear=year+Math.floor((newMonth-1)/12); const realMon=(newMonth-1)%12+1;
      const dt=new Date(Date.UTC(newYear, realMon-1, 1)); const name=dt.toLocaleString('ru-RU',{timeZone:'UTC',month:'long'}); res.push(`${name} ${newYear}`); }
    return res;
  }
  if(periodType === 'year' && /^\d{4}$/.test(lastLabel)){ const year=+lastLabel; for(let i=1;i<=count;i++) res.push(`${year+i} год`); return res; }
  if(periodType === 'quarter' && /^(\d{4})-Q([1-4])$/.test(lastLabel)){
    const m=lastLabel.match(/^(\d{4})-Q([1-4])$/); let year=+m[1], q=+m[2];
    for(let i=1;i<=count;i++){ const nq=q+i; const ny=year+Math.floor((nq-1)/4); const rq=((nq-1)%4)+1; res.push(`${ny}-й год, ${rq}-й квартал`); }
    return res;
  }
  if(periodType === 'week' && /^(\d{4})-W(\d{1,2})$/.test(lastLabel)){
    const m=lastLabel.match(/^(\d{4})-W(\d{1,2})$/); let year=+m[1], w=+m[2];
    for(let i=1;i<=count;i++){ const nw=w+i; const ny=year+Math.floor((nw-1)/52); const rw=((nw-1)%52)+1; res.push(`${ny}-й год, ${rw}-я неделя`); }
    return res;
  }
  for(let i=1;i<=count;i++) res.push(`+${i}`); return res;
}
function getBestDays(filtered){
  const byDow = {};
  filtered.forEach(r=>{ const d=parseDateAnyStrict(r.date); if(d){ const dow=d.getUTCDay(); const name=RU_WEEKDAYS[dow]; byDow[name]=(byDow[name]||0)+1; } });
  if(!Object.keys(byDow).length) return "Нет данных";
  const sorted=Object.entries(byDow).sort((a,b)=>a[1]-b[1]); const min=sorted[0][1];
  return sorted.filter(x=>x[1]===min).map(x=>x[0]).join(", ");
}
function smartRecommendations(filtered, grouped, period){
  if(!filtered.length) return ['Данных для анализа не найдено.'];
  const recs = [];
  const services={}, responsibles={}, reasons={}, days={};
  filtered.forEach(r=>{
    services[r.service]=(services[r.service]||0)+1;
    responsibles[r.responsible]=(responsibles[r.responsible]||0)+1;
    reasons[r.reason]=(reasons[r.reason]||0)+1;
    const d=parseDateAnyStrict(r.date); if(d){ const name=RU_WEEKDAYS[d.getUTCDay()]; days[name]=(days[name]||0)+1; }
  });
  const peakSvc  = Object.entries(services).sort((a,b)=>b[1]-a[1]);
  const peakResp = Object.entries(responsibles).sort((a,b)=>b[1]-a[1]);
  const peakReas = Object.entries(reasons).sort((a,b)=>b[1]-a[1]);
  const worstDay = Object.entries(days).sort((a,b)=>b[1]-a[1]);

  if(peakSvc.length)  recs.push(`Наибольшее число инцидентов в сервисе <b>${peakSvc[0][0]}</b> (${peakSvc[0][1]} случаев, ${Math.round(peakSvc[0][1]*100/filtered.length)}%).`);
  if(peakReas.length) recs.push(`Чаще всего причиной является: <b>${peakReas[0][0]}</b> (${peakReas[0][1]} случаев).`);
  if(peakResp.length) recs.push(`Ответственный с максимумом: <b>${peakResp[0][0]}</b>.`);
  if(worstDay.length) recs.push(`Больше всего инцидентов по <b>${worstDay[0][0]}</b>. Усильте мониторинг в этот день.`);

  if(filtered.length >= 30) recs.push(`Есть устойчивый тренд. Пересмотрите план профилактики.`);
  if(peakSvc.length>1 && Math.abs(peakSvc[0][1]-peakSvc[1][1])/filtered.length > 0.2)
    recs.push(`Высокая концентрация инцидентов в одном сервисе (${peakSvc[0][0]}). Рассмотрите перераспределение нагрузки.`);
  if(filtered.length>=10 && Object.keys(reasons).length>3)
    recs.push(`Причины разнообразны — нужен сквозной мониторинг на всех этапах.`);
  if(peakReas.length && /баланс|цена|стоимост/i.test(peakReas[0][0]))
    recs.push(`Много ошибок ценообразования/балансов. Усильте проверки обмена данными.`);
  if(filtered.length>50 && Object.keys(responsibles).length>6)
    recs.push(`Слишком много ответственных — укрупните зоны ответственности.`);

  return recs;
}

/* =========================================================
   СБОРКА ДАШБОРДА
   ========================================================= */
function buildDashboard(data, filename){ setFileInfo(filename, data.length); renderDashboard(data, { period:"month", service:"all", page:1 }); }
function renderDashboard(data, {period, service, customPeriod, groupBy, page=1}){
  DASHBOARD_STATE = { period, service, customPeriod, groupBy, page };

  const services = Array.from(new Set(data.map(r=>r.service))).sort();
  const html = `
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">
        Настройки анализа
        <span class="info-tip" data-tooltip="Фильтруйте данные для аналитики: выбирайте сервис, период и группировку.">i</span>
      </h2>

      <form id="filter-form" class="flex flex-wrap items-center gap-4" autocomplete="off">
        <label class="block text-gray-700 mb-2 mr-3">Сервис:
          <select id="service-filter" class="border border-gray-300 rounded-md px-3 py-2">
            <option value="all">Все сервисы</option>
            ${services.map(s=>`<option value="${s}" ${service===s?"selected":""}>${s}</option>`).join('')}
          </select>
        </label>

        <div class="flex flex-wrap gap-2 items-center">
          <label class="mr-2">Период:</label>
          <input type="hidden" id="period-input" value="${period}">
          <button type="button" class="segabtn ${period==='year'?'active':''}" data-period="year">Год</button>
          <button type="button" class="segabtn ${period==='quarter'?'active':''}" data-period="quarter">Квартал</button>
          <button type="button" class="segabtn ${period==='month'?'active':''}" data-period="month">Месяц</button>
          <button type="button" class="segabtn ${period==='week'?'active':''}" data-period="week">Неделя</button>
          <button type="button" class="segabtn ${period==='day'?'active':''}" data-period="day">День</button>
          <button type="button" class="segabtn ${period==='all'?'active':''}" data-period="all">Весь период</button>
          <button type="button" class="segabtn ${period==='custom'?'active':''}" data-period="custom">Свой период</button>
        </div>

        <div id="custom-period-block" class="flex gap-2 items-center ${period!=='custom'?'hidden':''}">
          <label>от <input type="date" id="custom-start" class="border border-gray-300 rounded-md px-2 py-1"></label>
          <label>до <input type="date" id="custom-end" class="border border-gray-300 rounded-md px-2 py-1"></label>
          <select id="group-by" class="border border-gray-300 rounded-md px-2 py-1">
            <option value="day">По дням</option>
            <option value="week">По неделям</option>
            <option value="month">По месяцам</option>
            <option value="quarter">По кварталам</option>
            <option value="year">По годам</option>
          </select>
        </div>

        <button type="submit" class="ml-2 px-7 py-2 font-bold rounded bg-indigo-700 hover:bg-indigo-900 text-white shadow-md">Показать</button>
      </form>
    </div>

    <div id="viz-blocks"></div>
  `;
  document.getElementById('dashboard-content').innerHTML = html;

  document.querySelectorAll('.segabtn[data-period]').forEach(btn=>{
    btn.onclick = function(){
      document.querySelectorAll('.segabtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('period-input').value = btn.getAttribute('data-period');
      if(btn.dataset.period === 'custom') document.getElementById('custom-period-block').classList.remove('hidden');
      else document.getElementById('custom-period-block').classList.add('hidden');
    };
  });
  document.getElementById('filter-form').onsubmit = function(e){
    e.preventDefault();
    const newService = document.getElementById('service-filter').value;
    const newPeriod  = document.getElementById('period-input').value;
    let customPeriod, groupBy;
    if(newPeriod === 'custom'){
      customPeriod = { start: document.getElementById('custom-start').value, end: document.getElementById('custom-end').value };
      groupBy = document.getElementById('group-by').value;
    }
    renderDashboard(RAW_DATA, { period:newPeriod, service:newService, customPeriod, groupBy, page:1 });
  };

  let filtered = (service === "all" ? data : data.filter(r => r.service === service))
    .map(r => ({ ...r, _date: parseDateAnyStrict(r.date) })).filter(r => r._date);

  if(period === 'custom' && customPeriod && customPeriod.start && customPeriod.end){
    const start = new Date(customPeriod.start+"T00:00:00Z");
    const end   = new Date(customPeriod.end+"T23:59:59Z");
    filtered = filtered.filter(r => r._date >= start && r._date <= end);
  }

  let group = (period === "custom" ? (groupBy || "day") : period);
  if(group === "all") group = "month";

  const grouped = groupByPeriod(filtered, group);
  renderVisualBlocks(filtered, grouped, group, page);
}

/* =========================================================
   ВИЗУАЛИЗАЦИИ + РЕДАКТОР ПРЕЗЕНТАЦИЙ + ЭКСПОРТЫ
   ========================================================= */
function renderVisualBlocks(filtered, grouped, period, page){
  const chartLabels = grouped.labels;
  const chartCounts = grouped.counts;
  const forecast = Array(3).fill(chartCounts.length ? Math.round(chartCounts.slice(-3).reduce((a,b)=>a+b,0)/Math.min(3,chartCounts.length)) : 0);
  const forecastPeriods = getNextPeriods(chartLabels[chartLabels.length-1], period, forecast.length);

  const serviceCount = {}, reasons = {}, responsibles = {};
  filtered.forEach(r=>{
    serviceCount[r.service]=(serviceCount[r.service]||0)+1;
    reasons[r.reason]=(reasons[r.reason]||0)+1;
    responsibles[r.responsible]=(responsibles[r.responsible]||0)+1;
  });
  const reasonsSorted = Object.entries(reasons).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const responsiblesSorted = Object.entries(responsibles).sort((a,b)=>b[1]-a[1]).slice(0,8);

  const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
  const pageSafe = Math.min(page, totalPages) || 1;
  const start = (pageSafe-1)*PAGE_SIZE, end = start + PAGE_SIZE;
  const pageRows = filtered.slice(start, end);

  const recommendations = smartRecommendations(filtered, grouped, period);
  const bestDays = getBestDays(filtered);

  document.getElementById('viz-blocks').innerHTML = `
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-2xl font-semibold text-gray-800">Динамика инцидентов</h2>
        <span class="info-tip" data-tooltip="История количества инцидентов по выбранному периоду.">i</span>
      </div>
      <canvas id="incidents-chart" height="110"></canvas>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold mb-2 flex items-center">
          Распределение по сервисам
          <span class="info-tip" data-tooltip="Диаграмма по сервисам — чем больше сектор, тем больше инцидентов.">i</span>
        </h3>
        <canvas id="services-pie" height="160"></canvas>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold mb-2 flex items-center">
          Топ-5 причин инцидентов
          <span class="info-tip" data-tooltip="Основные причины, показаны списком.">i</span>
        </h3>
        <ul class="reasons-list">
          ${reasonsSorted.map(x=>`<li>${x[0]} <span style="color:#9ca3af;font-weight:normal;">(${x[1]} инц.)</span></li>`).join('')}
        </ul>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="font-semibold mb-2 text-lg flex items-center">Прогноз
          <span class="info-tip" data-tooltip="Прогноз количества инцидентов на несколько будущих периодов.">i</span>
        </h3>
        <div>
          <span class="font-semibold text-indigo-800 text-lg">Прогноз на ${forecastPeriods.length} периода:</span>
          <ul class="mt-2 mb-3">
            ${forecast.map((val,i)=>`<li class="text-base text-violet-800 font-bold">${forecastPeriods[i]}: ${val}</li>`).join('')}
          </ul>
          <div class="mt-1 text-gray-700">Максимальный риск: <b>${findMaxKey(serviceCount)}</b></div>
          <div class="text-gray-700">Рекомендуемые дни для обслуживания: <b>${bestDays}</b></div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="font-semibold mb-2 text-lg flex items-center">Ответственные
          <span class="info-tip" data-tooltip="Топ-8 ответственных за инциденты.">i</span>
        </h3>
        <div class="mb-2 text-sm text-gray-500">Всего инцидентов: <b>${filtered.length}</b></div>
        <ul>
          ${responsiblesSorted.map(r=>`<li class="mb-1"><span class="text-indigo-700 font-semibold">${r[0]}</span>: <b>${r[1]} инц.</b></li>`).join('')}
        </ul>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="font-semibold mb-2 text-lg flex items-center">Ключевые рекомендации
          <span class="info-tip" data-tooltip="Рекомендации составлены на основе анализа данных.">i</span>
        </h3>
        <ul id="ai-recs-block">
          ${recommendations.map(txt=>`<li class="mb-2 text-base" style="margin-left:.5em;">${txt.replace(/<b>|<\/b>/g,'')}</li>`).join('')}
        </ul>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold text-gray-800">Детализированные данные</h2>
        <span class="info-tip" data-tooltip="Все инциденты из фильтра. Навигация по страницам — ниже.">i</span>

        <div class="flex items-center gap-3">
          <input id="global-search" type="text" placeholder="Поиск по всем полям..." class="px-3 py-2 border border-gray-300 rounded-md text-sm w-72" />
          <button id="export-xlsx" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Экспорт в Excel</button>
          <button id="open-slide-editor" class="bg-violet-600 text-white px-4 py-2 rounded hover:bg-violet-700">Создать презентацию</button>
        </div>
      </div>

      <div class="text-sm text-gray-500 mb-2">Все инциденты из фильтра. Навигация по страницам — ниже.</div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="result-table">
          <thead>
            <tr>
              <th class="px-3 py-2 text-left text-xs text-gray-600">Дата</th>
              <th class="px-3 py-2 text-left text-xs text-gray-600">Сервис</th>
              <th class="px-3 py-2 text-left text-xs text-gray-600">Причина</th>
              <th class="px-3 py-2 text-left text-xs text-gray-600">Ответственный</th>
            </tr>
          </thead>
          <tbody>
            ${pageRows.map(r=>`
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 text-sm">${formatDateRuUTC(parseDateAnyStrict(r.date))}</td>
                <td class="px-3 py-2 text-sm font-bold">${r.service}</td>
                <td class="px-3 py-2 text-sm">${r.reason}</td>
                <td class="px-3 py-2 text-sm">${r.responsible}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>

      <div class="flex justify-center mt-3">${renderPagination(pageSafe, totalPages)}</div>
      <div class="text-right text-xs text-gray-500 mt-2">Строк: ${filtered.length}, страница ${pageSafe} из ${totalPages}</div>
    </div>
  `;

  setTimeout(()=>{
    const ctx = document.getElementById('incidents-chart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: [...chartLabels, ...forecastPeriods],
        datasets: [
          {
            label: 'Количество инцидентов',
            data: [...chartCounts, ...Array(forecast.length).fill(null)],
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99,102,241,0.08)',
            borderWidth: 2, pointBackgroundColor:'#6366f1', pointRadius:4, fill:true, tension:.25
          },
          {
            label: 'Прогноз',
            data: Array(chartCounts.length).fill(null).concat(forecast),
            borderColor: '#ff8000', backgroundColor:'rgba(255,180,50,0.12)',
            borderDash:[8,5], pointRadius:5, fill:false, tension:.25
          }
        ]
      },
      options: {
        responsive:true,
        plugins:{ legend:{ display:true, position:'top' } },
        scales:{ y:{ beginAtZero:true, title:{display:true, text:'Количество инцидентов'} }, x:{ title:{display:true, text:'Период'} } },
        interaction:{ mode:'index', intersect:false }
      }
    });
    new Chart(document.getElementById('services-pie').getContext('2d'), {
      type:'pie',
      data:{ labels:Object.keys(serviceCount), datasets:[{ data:Object.values(serviceCount), backgroundColor:['#6366f1','#818cf8','#a5b4fc','#c7d2fe','#e0e7ff'] }] }
    });
  }, 200);

  document.getElementById('global-search').addEventListener('input', function(){
    const q = this.value.toLowerCase();
    document.querySelectorAll('#result-table tbody tr').forEach(row=>{
      row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  document.getElementById('export-xlsx').onclick = function(){
    const ws = XLSX.utils.aoa_to_sheet([
      ["Дата","Сервис","Причина","Ответственный"],
      ...filtered.map(r => [formatDateRuUTC(parseDateAnyStrict(r.date)), r.service, r.reason, r.responsible])
    ]);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Инциденты");
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    saveAs(new Blob([wbout],{type:"application/octet-stream"}), "инциденты.xlsx");
  };

  document.querySelectorAll('.pg-btn').forEach(btn=>{
    btn.onclick = function(){
      const page = +btn.getAttribute('data-page');
      renderDashboard(RAW_DATA, { ...DASHBOARD_STATE, page });
    };
  });

  document.getElementById('open-slide-editor').onclick = () => openSlideEditor();
}

/* Пагинация */
function renderPagination(current, total){
  if(total<=1) return "";
  const pages = [];
  if(total<10){ for(let i=1;i<=total;i++) pages.push(i); }
  else{
    if(current>3) pages.push(1,"...");
    for(let i=Math.max(1,current-2); i<=Math.min(total,current+2); i++) pages.push(i);
    if(current<total-2) pages.push("...", total);
  }
  return pages.map(p => p==="..." ? `<span class="pg-btn" disabled>...</span>`
                                  : `<button class="pg-btn${p===current?" active":""}" data-page="${p}">${p}</button>`).join('');
}

/* ---------------------------------------------------------
   Редактор презентации
   --------------------------------------------------------- */
let slides = [];
const corpTemplates = {
  chart:'График наглядно демонстрирует динамику инцидентов по выбранному периоду. Обращаем внимание на ключевые пики и снижение — это позволяет выделить периоды максимального риска и наметить меры его снижения.',
  pie:'Диаграмма по сервисам позволяет быстро выявить зоны концентрации инцидентов. Необходимо усилить контроль и провести аудит по наиболее проблемным сервисам.',
  reasons:'Наибольший вклад в количество инцидентов дают следующие причины. Для повышения надежности рекомендовано усилить мониторинг и устранение выявленных слабых мест.',
  responsibles:'Ответственные сотрудники с наибольшим числом инцидентов — фокус для обучения и усиления коммуникации.',
  forecast:'Прогноз сформирован на основе исторических данных. Рекомендуется обратить внимание на потенциальные периоды роста и заранее готовить меры реагирования.',
  table:'Таблица содержит ключевые данные по инцидентам за выбранный период.',
  recs:'Рекомендации подготовлены по итогам анализа данных.',
  upload:'Данный слайд добавлен вручную.'
};
function closeSlideEditor(){ document.getElementById('slide-editor-modal').style.display='none'; slides=[]; }
function openSlideEditor(){ document.getElementById('slide-editor-modal').style.display='block'; renderSlidesArea(); }
function renderSlidesArea(){
  const area = document.getElementById('slides-area');
  if(!slides.length){ area.innerHTML = `<div class="slide-empty-msg">Ни одного блока ещё не добавлено.<br>Воспользуйтесь кнопками выше.</div>`; return; }
  area.innerHTML = slides.map((b,i)=>getSlideBlockHtml(b,i)).join('');
  area.querySelectorAll('.slide-block-remove').forEach(btn=>{ btn.onclick = ()=>{ slides.splice(+btn.dataset.idx,1); renderSlidesArea(); }; });
  area.querySelectorAll('.slide-block-up').forEach(btn=>{ btn.onclick = ()=>{ const i=+btn.dataset.idx; if(i>0){ [slides[i-1],slides[i]]=[slides[i],slides[i-1]]; renderSlidesArea(); } }; });
  area.querySelectorAll('.slide-block-down').forEach(btn=>{ btn.onclick = ()=>{ const i=+btn.dataset.idx; if(i<slides.length-1){ [slides[i],slides[i+1]]=[slides[i+1],slides[i]]; renderSlidesArea(); } }; });
  area.querySelectorAll('.slide-block-corptext').forEach(el=>{ el.oninput = ()=>{ slides[+el.dataset.idx].corptext = el.innerText; }; });
}
function getSlideBlockHtml(block, idx){
  const ctrl = `<div class="slide-block-toolbar">
    <button class="slide-block-up" data-idx="${idx}" title="Вверх">⬆</button>
    <button class="slide-block-down" data-idx="${idx}" title="Вниз">⬇</button>
    <button class="slide-block-remove" data-idx="${idx}" title="Удалить">✖</button>
  </div>`;
  const corptext = `<div class="slide-block-corptext" contenteditable="true" data-idx="${idx}" spellcheck="false">${block.corptext||corpTemplates[block.type]||""}</div>`;
  switch(block.type){
    case 'chart': {
      const canvas = document.getElementById('incidents-chart');
      const img = canvas ? `<img src="${canvas.toDataURL('image/png')}" style="max-width:99%;margin:auto;display:block" alt="График" />` : '<i>График недоступен</i>';
      return `<div class="slide-block">${ctrl}<div class="slide-block-label">Динамика инцидентов</div>${img}${corptext}</div>`;
    }
    case 'pie': {
      const canvas = document.getElementById('services-pie');
      const img = canvas ? `<img src="${canvas.toDataURL('image/png')}" style="max-width:430px;max-height:210px;" alt="Круговая диаграмма" />` : '<i>Диаграмма недоступна</i>';
      return `<div class="slide-block">${ctrl}<div class="slide-block-label">Распределение по сервисам</div>${img}${corptext}</div>`;
    }
    case 'reasons': {
      const list = Array.from(document.querySelectorAll('.reasons-list li')).map(li=>li.textContent).slice(0,5).map(t=>`<li>${t}</li>`).join('');
      return `<div class="slide-block">${ctrl}<div class="slide-block-label">Топ-5 причин инцидентов</div><ul class="reasons-list">${list}</ul>${corptext}</div>`;
    }
    case 'responsibles': {
      const list = Array.from(document.querySelectorAll('.bg-white .text-indigo-700.font-semibold')).map(span => span.parentNode.textContent).slice(0,8).map(t=>`<li>${t}</li>`).join('');
      return `<div class="slide-block">${ctrl}<div class="slide-block-label">Топ-8 ответственных</div><ul class="reasons-list">${list}</ul>${corptext}</div>`;
    }
    case 'forecast': {
      const blockD = document.querySelector(".grid-cols-1.md\\:grid-cols-3 .font-semibold.text-lg")?.parentNode;
      const html = blockD ? blockD.innerHTML : "<i>Блок прогноза недоступен</i>";
      return `<div class="slide-block">${ctrl}<div class="slide-block-label">Прогноз инцидентов</div>${html}${corptext}</div>`;
    }
    case 'table': {
      const table = document.getElementById('result-table');
      if(!table) return `<div class="slide-block">${ctrl}<i>Таблица недоступна</i></div>`;
      const header = `<tr>${Array.from(table.querySelectorAll('thead th')).map(th=>`<th>${th.textContent}</th>`).join('')}</tr>`;
      const rows = Array.from(table.querySelectorAll('tbody tr')).slice(0,10).map(tr => `<tr>${Array.from(tr.children).map(td=>`<td>${td.textContent}</td>`).join('')}</tr>`).join('');
      return `<div class="slide-block">${ctrl}<div class="slide-block-label">Таблица инцидентов</div><table class="min-w-full text-sm">${header}${rows}</table>${corptext}</div>`;
    }
    case 'recs': {
      const recs = Array.from(document.querySelectorAll('#ai-recs-block li')).map(li=>`<li>${li.textContent}</li>`).join('');
      return `<div class="slide-block">${ctrl}<div class="slide-block-label">Ключевые рекомендации</div><ul>${recs}</ul>${corptext}</div>`;
    }
    case 'upload': {
      const img = block.data ? `<img src="${block.data}" class="slide-block-uploadimg" alt="Пользовательский слайд" />` : '';
      return `<div class="slide-block">${ctrl}<div class="slide-block-label">Пользовательский слайд</div>${img}${corptext}</div>`;
    }
    default: return `<div class="slide-block">${ctrl}<i>Блок</i></div>`;
  }
}
function addSlideBlock(type){
  if(type === 'upload'){
    const inp = document.createElement('input'); inp.type = "file"; inp.accept = "image/*,.pdf";
    inp.onchange = ()=>{
      const file = inp.files[0]; if(!file) return;
      if(file.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload = e => { slides.push({type:'upload', data:e.target.result}); renderSlidesArea(); };
        reader.readAsDataURL(file);
      } else if(file.type === "application/pdf"){ alert("PDF: вставьте скриншот первой страницы."); }
    };
    inp.click(); return;
  }
  slides.push({ type, corptext: corpTemplates[type] }); renderSlidesArea();
}

/* Экспорт в PDF (оставлен для удобства) */
async function exportSlidesToPdf(){
  const { jsPDF } = window.jspdf;
  const blocks = Array.from(document.querySelectorAll('#slides-area .slide-block'));
  if(!blocks.length) return;
  showLoading(true);

  const pdf = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
  const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();

  for(let i=0;i<blocks.length;i++){
    const canvas = await html2canvas(blocks[i], { scale:2, background:'#fff', windowWidth:blocks[i].scrollWidth, windowHeight:blocks[i].scrollHeight });
    const img = canvas.toDataURL('image/png');
    let w = pageW - 60, h = canvas.height * w / canvas.width;
    if(h > pageH - 80){ h = pageH - 80; w = canvas.width * h / canvas.height; }
    pdf.addImage(img, 'PNG', (pageW - w)/2, 40, w, h);
    if(i < blocks.length-1) pdf.addPage();
  }
  pdf.save('Презентация.pdf'); showLoading(false);
}

/* === НОВОЕ: Экспорт в PPTX с редактируемым текстом ===
   Графики/диаграммы остаются картинками, заголовки/списки/описания — текст. */
async function exportSlidesToPptx(){
  try{
    const blockEls = Array.from(document.querySelectorAll('#slides-area .slide-block'));
    if(!blockEls.length) return alert('Нет слайдов для экспорта.');
    if(typeof window.PptxGenJS !== 'function'){ alert('Библиотека PptxGenJS не загрузилась.'); return; }

    showLoading(true);

    const pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_16x9';

    // Геометрия для слайдов
    const pageW = 10, pageH = 5.625; // дюймы 16:9
    const M = 0.5;                    // поля
    const titleY = 0.3, titleH = 0.6;
    const bodyY  = 1.0;               // начало контента

    for(let i=0;i<slides.length;i++){
      const meta = slides[i];
      const el   = blockEls[i];

      const slide = pptx.addSlide();

      const title = el.querySelector('.slide-block-label')?.textContent?.trim() || '';
      const corptext = (typeof meta.corptext === 'string' && meta.corptext.trim()) ?
                        meta.corptext.trim() :
                        (el.querySelector('.slide-block-corptext')?.textContent?.trim() || '');

      // Заголовок — редактируемый текст
      if(title){
        slide.addText(title, {
          x: M, y: titleY, w: pageW-2*M, h: titleH,
          fontFace:'Arial', fontSize:24, bold:true, color:'4455EE'
        });
      }

      // Контент по типу блока
      if(meta.type === 'chart'){
        const canvas = document.getElementById('incidents-chart');
        if(canvas){
          const dataUrl = canvas.toDataURL('image/png');
          let w = pageW-2*M, h = (canvas.height * w / canvas.width);
          if(h > pageH - (bodyY+M)) { h = pageH - (bodyY+M); w = (canvas.width * h / canvas.height); }
          slide.addImage({ data:dataUrl, x:(pageW-w)/2, y:bodyY, w, h });
        }
      }
      else if(meta.type === 'pie'){
        const canvas = document.getElementById('services-pie');
        if(canvas){
          const dataUrl = canvas.toDataURL('image/png');
          let w = 4.8, h = 4.0; // компактно
          slide.addImage({ data:dataUrl, x:M, y:bodyY, w, h });
        }
      }
      else if(meta.type === 'table'){
        // Парсим таблицу из блока
        const head = Array.from(el.querySelectorAll('table thead th')).map(th=>th.textContent.trim());
        const rows = Array.from(el.querySelectorAll('table tbody tr')).slice(0,10).map(tr=>Array.from(tr.children).map(td=>td.textContent.trim()));
        const tbl = [ head.map(h => ({ text:h, options:{ bold:true } })) , ...rows ];
        slide.addTable(tbl, {
          x: M, y: bodyY, w: pageW-2*M,
          border:{ type:'solid', color:'999999', pt:1 },
          fontFace:'Arial', fontSize:12, colW:[2.2,2.2,4.2,2.2]
        });
      }
      else if(meta.type === 'upload'){
        if(meta.data){
          slide.addImage({ data: meta.data, x:M, y:bodyY, w: pageW-2*M, h: pageH-(bodyY+M), sizing:{ type:'contain', w:pageW-2*M, h:pageH-(bodyY+M) }});
        }
      }
      // reasons / responsibles / recs / forecast — собираем пункты и кладём как буллеты
      if(['reasons','responsibles','recs','forecast','pie'].includes(meta.type)){
        // Список li, если есть
        let items = Array.from(el.querySelectorAll('li')).map(li=>li.textContent.trim()).filter(Boolean);
        // Если «pie» — только картинка слева, текст-описание справа
        let x = meta.type==='pie' ? (M+5.2) : M;
        let w = meta.type==='pie' ? (pageW - x - M) : (pageW - 2*M);
        if(!items.length){
          const raw = el.textContent.replace(/\s+/g,' ').trim();
          if(raw) items = [raw];
        }
        if(items.length){
          slide.addText(
            items.map(t => ({ text: t, options:{ bullet:true, fontFace:'Arial', fontSize:16, color:'222222', breakLine:true } })),
            { x, y: bodyY, w, h: pageH-(bodyY+1.2) }
          );
        }
      }

      // Описание/комментарий — редактируемый текст внизу
      if(corptext){
        slide.addText(corptext, {
          x: M, y: pageH-0.9, w: pageW-2*M, h: 0.7,
          fontFace:'Arial', fontSize:14, color:'333333'
        });
      }
    }

    // Сохранение
    let blob;
    if(typeof pptx.write==='function'){ blob = await pptx.write('blob'); }
    else if(typeof pptx.stream==='function'){ blob = await pptx.stream(); }
    if(blob) saveAs(blob, 'Презентация.pptx');
    else await pptx.writeFile({ fileName:'Презентация.pptx' });

  } catch(err){
    console.error('PPTX export error:', err);
    alert('Ошибка экспорта в PPTX: ' + err.message);
  } finally {
    showLoading(false);
  }
}
</script>

<!-- Модалка редактора презентаций -->
<div id="slide-editor-modal">
  <div id="slide-editor-content">
    <h2 class="text-xl font-bold mb-3 text-gray-800 flex items-center gap-2">
      Создание презентации
      <span class="info-tip" data-tooltip="Добавьте нужные блоки на слайд, меняйте их порядок, редактируйте тексты.">i</span>
    </h2>

    <div class="editor-toolbar mb-4 flex flex-wrap gap-2">
      <button onclick="addSlideBlock('chart')" class="segabtn">+ График</button>
      <button onclick="addSlideBlock('pie')" class="segabtn">+ Круговая по сервисам</button>
      <button onclick="addSlideBlock('reasons')" class="segabtn">+ Причины</button>
      <button onclick="addSlideBlock('responsibles')" class="segabtn">+ Ответственные</button>
      <button onclick="addSlideBlock('forecast')" class="segabtn">+ Прогноз</button>
      <button onclick="addSlideBlock('table')" class="segabtn">+ Таблица</button>
      <button onclick="addSlideBlock('recs')" class="segabtn">+ Рекомендации</button>
      <button onclick="addSlideBlock('upload')" class="segabtn">+ Свой слайд</button>

      <!-- Экспорт -->
      <button onclick="exportSlidesToPptx()" class="segabtn" title="Скачать презентацию в PPTX">🟦 Экспорт в PPTX</button>
      <button onclick="exportSlidesToPdf()" class="segabtn" title="Скачать презентацию в PDF">📄 Экспорт в PDF</button>

      <button onclick="closeSlideEditor()" style="background:#ef4444;" class="segabtn">✖ Закрыть</button>
    </div>

    <div id="slides-area" style="overflow:visible; min-height:40vh; max-height:none;">
      <div class="slide-empty-msg">Ни одного блока ещё не добавлено.<br>Воспользуйтесь кнопками выше.</div>
    </div>
  </div>
</div>

</body>
</html>
